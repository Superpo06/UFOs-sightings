<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Convertisseur CSV ‚Üí GeoJSON avec codes pays</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .info-box {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #b3d9ff;
        }
        .file-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .file-input {
            margin: 15px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-input:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }
        #fileInfo, #mappingFileInfo {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover:not(:disabled) {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress {
            display: none;
            margin: 25px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }
        .result {
            display: none;
            margin-top: 25px;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .error {
            color: #d32f2f;
            padding: 15px;
            background: #ffebee;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }
        .stats {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
        }
        #mappingStatus {
            font-size: 14px;
            margin: 10px 0;
            min-height: 20px;
            padding: 10px;
            border-radius: 5px;
            background: #f5f5f5;
        }
        .status-ok {
            color: #4CAF50;
        }
        .status-waiting {
            color: #ff9800;
        }
        .status-error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Convertisseur CSV ‚Üí GeoJSON avec codes pays</h1>
    
    <div class="info-box">
        <h3>üìã Instructions :</h3>
        <ol>
            <li>S√©lectionnez le fichier de mapping pays (CSV avec colonnes Name,Code)</li>
            <li>S√©lectionnez le fichier CSV OVNI √† convertir</li>
            <li>Cliquez sur "Convertir en GeoJSON"</li>
            <li>T√©l√©chargez le r√©sultat</li>
        </ol>
    </div>
    
    <div class="file-section">
        <h3>1. üìÅ Fichier de mapping des pays</h3>
        <p><small>Format CSV avec en-t√™te : <code>Name,Code</code></small></p>
        <div class="file-input" id="mappingDropArea">
            <p>Cliquez ici ou d√©posez votre fichier de mapping CSV</p>
            <input type="file" id="mappingFile" accept=".csv" style="display: none;">
        </div>
        <div id="mappingFileInfo">Aucun fichier de mapping s√©lectionn√©</div>
        <div id="mappingStatus">‚åõ En attente du fichier de mapping...</div>
    </div>
    
    <div class="file-section">
        <h3>2. üìä Fichier CSV OVNI √† convertir</h3>
        <p><small>Format CSV avec point-virgule comme s√©parateur (16+ colonnes)</small></p>
        <div class="file-input" id="dataDropArea">
            <p>Cliquez ici ou d√©posez votre fichier CSV OVNI</p>
            <input type="file" id="dataFile" accept=".csv" style="display: none;">
        </div>
        <div id="fileInfo">Aucun fichier OVNI s√©lectionn√©</div>
    </div>
    
    <button id="convertBtn" disabled>Convertir en GeoJSON</button>
    
    <div class="progress" id="progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 14px; font-weight: bold;">0%</div>
    </div>
    
    <div class="error" id="error"></div>
    
    <div class="result" id="result">
        <h3 style="color: #4CAF50;">‚úÖ Conversion r√©ussie !</h3>
        <div id="status"></div>
        
        <div class="stats" id="stats"></div>
        
        <button id="downloadBtn" style="background: #2196F3;">üì• T√©l√©charger GeoJSON</button>
        <button id="resetBtn" style="background: #ff9800;">üîÑ Recommencer</button>
    </div>

    <script>
        let geoJSONData = null;
        let conversionStats = null;
        let countryMapping = {};
        let isConverting = false;
        
        // R√©cup√©rer les √©l√©ments DOM
        const mappingFileInput = document.getElementById('mappingFile');
        const dataFileInput = document.getElementById('dataFile');
        const mappingDropArea = document.getElementById('mappingDropArea');
        const dataDropArea = document.getElementById('dataDropArea');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const fileInfo = document.getElementById('fileInfo');
        const mappingFileInfo = document.getElementById('mappingFileInfo');
        const mappingStatus = document.getElementById('mappingStatus');
        
        // Gestionnaires pour le fichier de mapping
        mappingDropArea.addEventListener('click', function() {
            mappingFileInput.click();
        });
        
        mappingFileInput.addEventListener('change', function(e) {
            handleMappingFileSelection(e.target.files[0]);
        });
        
        mappingDropArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#2196F3';
        });
        
        mappingDropArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
        });
        
        mappingDropArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
            const file = e.dataTransfer.files[0];
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                handleMappingFileSelection(file);
                mappingFileInput.files = e.dataTransfer.files;
            } else {
                showError('Veuillez d√©poser un fichier CSV pour le mapping');
            }
        });
        
        // Gestionnaires pour le fichier de donn√©es
        dataDropArea.addEventListener('click', function() {
            dataFileInput.click();
        });
        
        dataFileInput.addEventListener('change', function(e) {
            handleDataFileSelection(e.target.files[0]);
        });
        
        dataDropArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#4CAF50';
        });
        
        dataDropArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
        });
        
        dataDropArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ccc';
            const file = e.dataTransfer.files[0];
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                handleDataFileSelection(file);
                dataFileInput.files = e.dataTransfer.files;
            } else {
                showError('Veuillez d√©poser un fichier CSV OVNI');
            }
        });
        
        // Gestionnaire du bouton de conversion
        convertBtn.addEventListener('click', convertFile);
        
        // Gestionnaire du bouton de t√©l√©chargement
        downloadBtn.addEventListener('click', downloadGeoJSON);
        
        // Gestionnaire du bouton de r√©initialisation
        resetBtn.addEventListener('click', resetConverter);
        
        async function handleMappingFileSelection(file) {
            if (!file) return;
            
            const sizeKB = (file.size / 1024).toFixed(1);
            mappingFileInfo.textContent = `Fichier de mapping : ${file.name} (${sizeKB} KB)`;
            mappingStatus.innerHTML = `‚åõ Chargement du mapping...`;
            mappingStatus.className = 'status-waiting';
            
            try {
                const text = await readFile(file);
                const success = parseMappingCSV(text);
                
                if (success) {
                    mappingStatus.innerHTML = `‚úÖ Mapping charg√© : ${Object.keys(countryMapping).length} pays`;
                    mappingStatus.className = 'status-ok';
                    checkReadyState();
                } else {
                    mappingStatus.innerHTML = `‚ùå Format invalide. Attendu: Name,Code`;
                    mappingStatus.className = 'status-error';
                    countryMapping = {};
                }
            } catch (error) {
                mappingStatus.innerHTML = `‚ùå Erreur de lecture : ${error.message}`;
                mappingStatus.className = 'status-error';
                countryMapping = {};
            }
        }
        
        function parseMappingCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return false;
            
            // V√©rifier l'en-t√™te
            const header = lines[0].toLowerCase();
            if (!header.includes('name') || !header.includes('code')) {
                return false;
            }
            
            // Parser les donn√©es
            countryMapping = {};
            let parsedCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    let name, code;
                    
                    // Gestion des guillemets
                    if (line.startsWith('"')) {
                        const firstQuoteEnd = line.indexOf('"', 1);
                        name = line.substring(1, firstQuoteEnd);
                        code = line.substring(firstQuoteEnd + 2);
                    } else {
                        const commaIndex = line.indexOf(',');
                        if (commaIndex === -1) continue;
                        name = line.substring(0, commaIndex);
                        code = line.substring(commaIndex + 1);
                    }
                    
                    countryMapping[name.trim()] = code.trim();
                    parsedCount++;
                    
                } catch (error) {
                    console.warn(`Erreur parsing ligne ${i}: ${line}`, error);
                }
            }
            
            return parsedCount > 0;
        }
        
        function handleDataFileSelection(file) {
            if (file) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
                fileInfo.textContent = `Fichier OVNI : ${file.name} (${sizeMB} MB)`;
                hideError();
                checkReadyState();
            }
        }
        
        function checkReadyState() {
            const hasMapping = Object.keys(countryMapping).length > 0;
            const hasDataFile = dataFileInput.files.length > 0;
            
            convertBtn.disabled = !(hasMapping && hasDataFile);
            
            if (hasMapping && hasDataFile) {
                convertBtn.textContent = "Convertir en GeoJSON ‚úÖ";
            } else {
                convertBtn.textContent = "Convertir en GeoJSON";
            }
        }
        
        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('error').style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function updateProgress(percent) {
            const progressPercent = Math.min(100, Math.max(0, percent));
            document.getElementById('progressFill').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = Math.round(progressPercent) + '%';
        }
        
        function getCountryCode(countryName) {
            if (!countryName) return '';
            
            // Essayer la correspondance exacte
            if (countryMapping[countryName]) {
                return countryMapping[countryName];
            }
            
            // Essayer la correspondance insensible √† la casse
            const lowerCountryName = countryName.toLowerCase();
            for (const [name, code] of Object.entries(countryMapping)) {
                if (name.toLowerCase() === lowerCountryName) {
                    return code;
                }
            }
            
            return '';
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(cell => cell.trim());
        }
        
        async function convertFile() {
            if (!dataFileInput.files.length || Object.keys(countryMapping).length === 0) return;
            
            const file = dataFileInput.files[0];
            if (isConverting) return;
            
            isConverting = true;
            hideError();
            document.getElementById('result').style.display = 'none';
            document.getElementById('progress').style.display = 'block';
            convertBtn.disabled = true;
            
            try {
                // Lire le fichier
                updateProgress(5);
                const text = await readFile(file);
                updateProgress(10);
                
                // Traiter le CSV
                const lines = text.split('\n');
                const dataLines = lines.slice(1).filter(line => line.trim());
                
                if (dataLines.length === 0) {
                    throw new Error('Aucune donn√©e trouv√©e dans le fichier');
                }
                
                const features = [];
                let errors = 0;
                const chunkSize = 10000;
                const totalChunks = Math.ceil(dataLines.length / chunkSize);
                
                for (let chunk = 0; chunk < totalChunks; chunk++) {
                    const start = chunk * chunkSize;
                    const end = Math.min(start + chunkSize, dataLines.length);
                    
                    for (let i = start; i < end; i++) {
                        const line = dataLines[i];
                        try {
                            const cols = parseCSVLine(line);
                            
                            if (cols.length < 16) {
                                errors++;
                                continue;
                            }
                            
                            const lat = parseFloat(cols[11]?.replace(',', '.'));
                            const lon = parseFloat(cols[12]?.replace(',', '.'));
                            
                            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                                errors++;
                                continue;
                            }
                            
                            const countryName = cols[8] || '';
                            const countryCode = getCountryCode(countryName);
                            
                            features.push({
                                type: "Feature",
                                geometry: {
                                    type: "Point",
                                    coordinates: [lon, lat]
                                },
                                properties: {
                                    id: cols[0] || `obs-${i}`,
                                    datetime: cols[1] || '',
                                    report_date: cols[2] || '',
                                    year: parseInt(cols[3]) || 0,
                                    month: cols[4] || '',
                                    hour: cols[5] || '',
                                    season: cols[6] || '',
                                    country_code: countryCode || '',
                                    country: countryName,
                                    state: cols[9] || '',
                                    city: cols[10] || '',
                                    shape: cols[13] || '',
                                    duration: cols[14] || '',
                                    description: cols.slice(15).join(";") || ''
                                }
                            });
                        } catch {
                            errors++;
                        }
                    }
                    
                    // Mettre √† jour la progression
                    const percent = ((chunk + 1) / totalChunks) * 85;
                    updateProgress(10 + percent);
                    
                    // Lib√©rer le thread
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
                
                if (features.length === 0) {
                    throw new Error('Aucune donn√©e valide n\'a pu √™tre convertie');
                }
                
                // Cr√©er le GeoJSON
                geoJSONData = {
                    type: "FeatureCollection",
                    features: features
                };
                
                conversionStats = {
                    total: features.length,
                    errors: errors,
                    successRate: ((features.length / dataLines.length) * 100).toFixed(1)
                };
                
                // Afficher les r√©sultats
                updateProgress(100);
                
                document.getElementById('stats').innerHTML = `
                    <strong>üìä R√©sultats :</strong><br><br>
                    ‚Ä¢ Observations converties : <strong>${conversionStats.total.toLocaleString()}</strong><br>
                    ‚Ä¢ Lignes ignor√©es : <strong>${conversionStats.errors.toLocaleString()}</strong><br>
                    ‚Ä¢ Taux de r√©ussite : <strong>${conversionStats.successRate}%</strong><br>
                    ‚Ä¢ Pays dans le mapping : <strong>${Object.keys(countryMapping).length}</strong>
                `;
                
                document.getElementById('status').innerHTML = `
                    <div style="color: #4CAF50; font-weight: bold;">
                        ‚úÖ Conversion termin√©e avec succ√®s !<br>
                        Les codes pays ont √©t√© ajout√©s depuis votre fichier de mapping.
                    </div>
                `;
                
                document.getElementById('result').style.display = 'block';
                document.getElementById('progress').style.display = 'none';
                convertBtn.disabled = false;
                
            } catch (error) {
                showError('Erreur : ' + error.message);
                document.getElementById('progress').style.display = 'none';
                convertBtn.disabled = false;
            }
            
            isConverting = false;
        }
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function downloadGeoJSON() {
            if (!geoJSONData) return;
            
            try {
                const jsonStr = JSON.stringify(geoJSONData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ufo-sightings-with-codes.geojson';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                showError('Erreur lors du t√©l√©chargement: ' + error.message);
            }
        }
        
        function resetConverter() {
            geoJSONData = null;
            conversionStats = null;
            countryMapping = {};
            
            mappingFileInput.value = '';
            dataFileInput.value = '';
            
            mappingFileInfo.textContent = 'Aucun fichier de mapping s√©lectionn√©';
            fileInfo.textContent = 'Aucun fichier OVNI s√©lectionn√©';
            
            mappingStatus.innerHTML = '‚åõ En attente du fichier de mapping...';
            mappingStatus.className = 'status-waiting';
            
            document.getElementById('result').style.display = 'none';
            convertBtn.disabled = true;
            convertBtn.textContent = "Convertir en GeoJSON";
            hideError();
            updateProgress(0);
        }
    </script>
</body>
</html>