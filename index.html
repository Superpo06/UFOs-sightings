<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Le Musée des OVNIs</title>

    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        /* Side panel */
        
        #sidepanel {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            z-index: 1000;
            transition: transform 0.3s;
            overflow-y: auto;
        }
        
        #sidepanel.collapsed {
            transform: translateX(-260px);
        }
        
        #togglePanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: black;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            z-index: 1100;
        }
        
        h2 {
            margin-top: 40px;
            font-size: 18px;
        }
        
        label {
            display: block;
            margin-top: 15px;
            font-size: 14px;
        }
        
        select,
        input {
            width: 100%;
        }
        
        #yearValue {
            font-size: 13px;
        }
        
        canvas {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <!-- Side Panel -->
    <div id="sidepanel" class="collapsed">
        <button id="togglePanel">☰</button>

        <h2>Observations OVNI</h2>

        <label for="countryFilter">Pays</label>
        <select id="countryFilter">
            <option value="all">Tous les pays</option>
        </select>

        <label for="yearFilter">Jusqu'à l'année</label>
        <input type="range" id="yearFilter" min="1900" max="2025" value="2025">
        <span id="yearValue">2025</span>

        <canvas id="timeChart" height="200"></canvas>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <script>
        "use strict";

        let allFeatures = [];
        let markersLayer = L.layerGroup();
        let chart;
        let countryNameToCode = {};
        let codeToName = {};

        /* CSV ➜ GeoJSON */
        function fromCSVtoJSON(csvText) {
            let lines = csvText.trim().split("\n").slice(1);
            let features = [];

            for (let line of lines) {
                let cols = line.split(";");

                if (cols.length < 16) continue;

                let lat = parseFloat(cols[11]);
                let lon = parseFloat(cols[12]);

                if (isNaN(lat) || isNaN(lon)) continue;

                features.push({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lon, lat]
                    },
                    properties: {
                        id: cols[0],
                        datetime: cols[1],
                        report_date: cols[2],
                        year: parseInt(cols[3]),
                        month: cols[4],
                        hour: cols[5],
                        season: cols[6],
                        country_code: cols[7],
                        country: cols[8],
                        state: cols[9],
                        city: cols[10],
                        shape: cols[13],
                        duration: cols[14],
                        description: cols.slice(15).join(";")
                    }
                });
            }

            return {
                type: "FeatureCollection",
                features
            };
        }

        function highlightFeature(e) {
            e.target.setStyle({
                weight: 3,
                color: '#FFFF00' // yellow on hover
            });
        }

        /* Add markers */
        function addMarkers(map, features) {
            markersLayer.clearLayers();

            for (let f of features) {
                let lat = f.geometry.coordinates[1];
                let lon = f.geometry.coordinates[0];

                let popup = `
                    <b>${f.properties.city}, ${f.properties.state}</b><br>
                    <b>Forme :</b> ${f.properties.shape}<br>
                    <b>Année :</b> ${f.properties.year}<br>
                    <b>Durée :</b> ${f.properties.duration}<br><br>
                    ${f.properties.description}
                `;

                L.circleMarker([lat, lon], {
                    radius: 4,
                    color: "#00ffcc",
                    weight: 1,
                    fillOpacity: 0.8
                }).bindPopup(popup).addTo(markersLayer);
            }

            markersLayer.addTo(map);
        }

        function applyFilters() {
            let selectedCountry = countryFilter.value;
            let year = parseInt(yearFilter.value);

            let filtered = allFeatures.filter(f => {
                return (selectedCountry === "all" || f.properties.country === selectedCountry) &&
                    f.properties.year <= year;
            });

            addMarkers(map, filtered);
            updateChart(filtered);
        }

        /* Chart */
        function updateChart(features) {
            let counts = {};

            features.forEach(f => {
                let y = f.properties.year;
                counts[y] = (counts[y] || 0) + 1;
            });

            let years = Object.keys(counts).sort();
            let values = years.map(y => counts[y]);

            if (chart) chart.destroy();

            chart = new Chart(document.getElementById("timeChart"), {
                type: "line",
                data: {
                    labels: years,
                    datasets: [{
                        data: values,
                        borderColor: "#00ffcc",
                        tension: 0.2
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: "white"
                            }
                        },
                        y: {
                            ticks: {
                                color: "white"
                            }
                        }
                    }
                }
            });
        }

        function addCountriesBorders(map, countriesGeoJSON) {
            let countriesLayer = L.geoJSON(countriesGeoJSON, {
                style: {
                    color: "#00FF00",
                    weight: 2,
                    fillOpacity: 0
                },
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: e => countriesLayer.resetStyle(e.target),
                        click: function() {
                            if (feature.properties && feature.properties.cca2) {
                                let code = feature.properties.cca2;
                                countryFilter.value = code; // select in dropdown
                                applyFilters(); // apply filter
                            }
                        }
                    });

                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(feature.properties.name);
                    }
                }
            }).addTo(map);
        }

        async function loadCountryMapping() {
            let response = await fetch("data/country_name_mapping.csv");
            let text = await response.text();
            let lines = text.trim().split("\n").slice(1);

            for (let line of lines) {
                let [name, code] = line.split(",");
                countryNameToCode[name] = code;
                codeToName[code] = name;
            }
        }

        /* Init */
        let map;

        window.onload = async() => {
            map = L.map('map', {
                center: [20, 0],
                zoom: 3,
                minZoom: 2
            });

            L.tileLayer(
                'https://tiles.stadiamaps.com/tiles/stamen_toner_dark/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20
                }
            ).addTo(map);

            await loadCountryMapping();

            let response = await fetch("data/ufo-sightings.csv");
            let csvTextData = await response.text();
            let jsondata = fromCSVtoJSON(csvTextData);

            allFeatures = jsondata.features;

            allFeatures.forEach(f => {
                // CSV already has country name
                let name = f.properties.country;
                f.properties.country_code = countryNameToCode[name] || null;
            });

            let countries = [...new Set(allFeatures.map(f => f.properties.country))].sort();
            countries.forEach(s => {
                let opt = document.createElement("option");
                opt.value = s;
                opt.textContent = s;
                countryFilter.appendChild(opt);
            });

            addMarkers(map, allFeatures);
            updateChart(allFeatures);

            let responseCountries = await fetch("data/countries.json");
            let countriesText = await responseCountries.text();
            let countriesGeoJSON = JSON.parse(countriesText);


            addCountriesBorders(map, countriesGeoJSON);

            countryFilter.onchange = applyFilters;
            yearFilter.oninput = () => {
                yearValue.textContent = yearFilter.value;
                applyFilters();
            };

            togglePanel.onclick = () => {
                sidepanel.classList.toggle("collapsed");
                togglePanel.textContent =
                    sidepanel.classList.contains("collapsed") ? "☰" : "✕";
            };

        };
    </script>

</body>

</html>