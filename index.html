<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Le Musée des OVNIs</title>

    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        /* Side panel */
        
        #sidepanel {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            z-index: 1000;
            transition: transform 0.3s;
            overflow-y: auto;
        }
        
        #sidepanel.collapsed {
            transform: translateX(-260px);
        }
        
        #togglePanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: black;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            z-index: 1100;
        }
        
        h2 {
            margin-top: 40px;
            font-size: 18px;
        }
        
        label {
            display: block;
            margin-top: 15px;
            font-size: 14px;
        }
        
        select,
        input {
            width: 100%;
        }
        
        #yearValue {
            font-size: 13px;
        }
        
        canvas {
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <!-- Side Panel -->
    <div id="sidepanel" class="collapsed">
        <button id="togglePanel">☰</button>

        <h2>Observations OVNI</h2>

        <label for="countryFilter">Pays</label>
        <select id="countryFilter">
            <option value="all">Tous les pays</option>
        </select>

        <label for="yearFilter">Jusqu'à l'année</label>
        <input type="range" id="yearFilter" min="1900" max="2025" value="2025">
        <span id="yearValue">2025</span>

        <canvas id="timeChart" height="200"></canvas>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <script>
        "use strict";
        /* Met en surbrillance la frontière du pays au survol */
        function highlightFeature(e) {
            e.target.setStyle({
                weight: 3,
                color: '#FFFF00'
            });
        }

        /* Ajoute des marqueurs pour les observations filtrées */
        function addMarkers(map, features) {
            markersLayer.clearLayers();

            for (let f of features) {
                let lat = f.geometry.coordinates[1];
                let lon = f.geometry.coordinates[0];

                let popup = `
                    <b>${f.properties.city}, ${f.properties.state}</b><br>
                    <b>Forme :</b> ${f.properties.shape}<br>
                    <b>Année :</b> ${f.properties.year}<br>
                    <b>Durée :</b> ${f.properties.duration}<br><br>
                    ${f.properties.description}
                `;

                L.circleMarker([lat, lon], {
                    radius: 4,
                    color: "#00ffcc",
                    weight: 1,
                    fillOpacity: 0.8
                }).bindPopup(popup).addTo(markersLayer);
            }

            markersLayer.addTo(map);
        }

        function applyFilters() {
            let selectedCountry = countryFilter.value;
            let year = parseInt(yearFilter.value);

            let filtered = allFeatures.filter(f => {
                return (selectedCountry === "all" ||
                        f.properties.country_code === selectedCountry) &&
                    f.properties.year <= year;
            });

            addMarkers(map, filtered);
            updateChart(filtered);
        }

        /* Chart */
        function updateChart(features) {
            const canvas = document.getElementById("timeChart");
            const ctx = canvas.getContext("2d");

            // Nettoyage
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Comptage par année
            let counts = {};
            features.forEach(f => {
                let y = f.properties.year;
                counts[y] = (counts[y] || 0) + 1;
            });

            let years = Object.keys(counts).map(Number).sort((a, b) => a - b);
            if (years.length === 0) return;

            let values = years.map(y => counts[y]);

            const padding = 30;
            const w = canvas.width - padding * 2;
            const h = canvas.height - padding * 2;

            const maxValue = Math.max(...values);

            // Axes
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1;

            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + h);
            ctx.lineTo(padding + w, padding + h);
            ctx.stroke();

            // Courbe
            ctx.strokeStyle = "#00ffcc";
            ctx.lineWidth = 2;
            ctx.beginPath();

            years.forEach((year, i) => {
                const x = padding + (i / (years.length - 1)) * w;
                const y = padding + h - (values[i] / maxValue) * h;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Points
            ctx.fillStyle = "#00ffcc";
            years.forEach((year, i) => {
                const x = padding + (i / (years.length - 1)) * w;
                const y = padding + h - (values[i] / maxValue) * h;

                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }


        function addCountriesBorders(map, countriesGeoJSON) {

            let countriesLayer = L.geoJSON(countriesGeoJSON, {
                style: {
                    color: "#00FF00",
                    weight: 2,
                    fillOpacity: 0
                },
                onEachFeature: function(feature, layer) {

                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: e => countriesLayer.resetStyle(e.target),

                        click: function() {
                            if (feature.properties && feature.properties.cca2) {
                                const code = feature.properties.cca2;
                                console.log("Pays cliqué :", code);
                                countryFilter.value = code;

                                applyFilters();
                            }
                        }
                    });

                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(feature.properties.name.common);
                    }
                }
            }).addTo(map);
        }




        async function load_data() {
            const response = await fetch("data/ufo-sightings-with-codes.geojson");
            const geojson = await response.json();
            return geojson.features;
        }


        /* Init */
        let map;
        let allFeatures = [];
        let markersLayer = L.layerGroup();
        let chart;


        window.onload = async() => {
            map = L.map('map', {
                center: [20, 0],
                zoom: 3,
                minZoom: 2
            });

            L.tileLayer(
                'https://tiles.stadiamaps.com/tiles/stamen_toner_dark/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20
                }
            ).addTo(map);

            /* Créee les feature et ajoute le mapping */
            allFeatures = await load_data();

            let countries = [...new Set(allFeatures.map(f => f.properties.country_code))].sort();

            countries.forEach(s => {
                let opt = document.createElement("option");
                opt.value = s;
                opt.textContent = s;
                countryFilter.appendChild(opt);
            });

            addMarkers(map, allFeatures);
            updateChart(allFeatures);

            let responseCountries = await fetch("data/countries.json");
            let countriesText = await responseCountries.text();
            let countriesGeoJSON = JSON.parse(countriesText);


            addCountriesBorders(map, countriesGeoJSON);

            countryFilter.onchange = applyFilters;
            yearFilter.oninput = () => {
                yearValue.textContent = yearFilter.value;
                applyFilters();
            };

            togglePanel.onclick = () => {
                sidepanel.classList.toggle("collapsed");
                togglePanel.textContent =
                    sidepanel.classList.contains("collapsed") ? "☰" : "✕";
            };

        };
    </script>

</body>

</html>