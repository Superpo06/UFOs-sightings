<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>
        <Le MusÃ©e des OVNIs>
    </title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
 #map {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
}
</style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        "use strict";

        function fromCSVtoJSON(csvText) {
            let lines = csvText.trim().split("\n");

            let features = [];

            for (let line of lines) {
                let cols = line.split(";");

                // Skip invalid lines
                if (cols.length < 14) continue;

                let lat = parseFloat(cols[10]);
                let lon = parseFloat(cols[11]);

                if (isNaN(lat) || isNaN(lon)) continue;

                let feature = {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lon, lat]
                    },
                    properties: {
                        id: cols[0],
                        datetime: cols[1],
                        report_date: cols[2],
                        year: cols[3],
                        month: cols[4],
                        hour: cols[5],
                        season: cols[6],
                        country_code: cols[7],
                        country: cols[8],
                        state: cols[9],
                        city: cols[10],
                        shape: cols[12],
                        duration: cols[13],
                        description: cols.slice(14).join(";") // rest of line (may contain ;)
                    }
                };

                features.push(feature);
            }

            return {
                type: "FeatureCollection",
                features: features
            };
        }

        function buildLayer(map, data) {
            let geoLayer;
            if (geoLayer) geoLayer.remove();

            geoLayer = L.geoJSON(data);

            geoLayer.addTo(map);
        }

        window.onload = async () => {
            let mapBounds = L.latLngBounds(
                L.latLng(-90, -180),
                L.latLng(90, 180)
            );
            let map = L.map('map', {
                center: [20, 0],
                zoom: 3,
                minZoom: 2,
                maxBounds: mapBounds,
                maxBoundsViscosity: 1.0,
                bounceAtZoomLimits: false
            });

            var Stadia_StamenTonerDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_dark/{z}/{x}/{y}{r}.{ext}', {
                minZoom: 0,
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            Stadia_StamenTonerDark.addTo(map);
            let response = await fetch("data/ufo-sightings.csv");
            let csvTextData = await response.text();
            let jsondata = await fromCSVtoJSON(csvTextData);

            buildLayer(map, jsondata);
        };
    </script>
</head>

<body>
    <div id="map"></div>
</body>

</html>