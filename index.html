<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>
        <Le Musée des OVNIs>
    </title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <style>
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        "use strict";

        /* CSV ➜ GeoJSON */
        function fromCSVtoJSON(csvText) {
            let lines = csvText.trim().split("\n");
            let features = [];

            for (let line of lines) {
                let cols = line.split(";");

                if (cols.length < 16) continue;

                let lat = parseFloat(cols[11]);
                let lon = parseFloat(cols[12]);

                if (isNaN(lat) || isNaN(lon)) continue;

                features.push({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lon, lat]
                    },
                    properties: {
                        id: cols[0],
                        datetime: cols[1],
                        report_date: cols[2],
                        year: cols[3],
                        month: cols[4],
                        hour: cols[5],
                        season: cols[6],
                        country_code: cols[7],
                        country: cols[8],
                        state: cols[9],
                        city: cols[10],
                        shape: cols[13],
                        duration: cols[14],
                        description: cols.slice(15).join(";")
                    }
                });
            }

            return {
                type: "FeatureCollection",
                features
            };
        }

        /* Add markers */
        function addMarkers(map, jsondata) {
            let i = 0;
            for (let f of jsondata.features) {
                if (i == 1000) break;
                let lat = f.geometry.coordinates[1];
                let lon = f.geometry.coordinates[0];

                let popup = `
                <b>${f.properties.city}, ${f.properties.state}</b><br>
                <b>Shape:</b> ${f.properties.shape}<br>
                <b>Duration:</b> ${f.properties.duration}<br><br>
                ${f.properties.description}
            `; /* Formattage du texte des popups */

                L.marker([lat, lon]).addTo(map).bindPopup(popup);
                i++;
            }
        }

        function buildLayer(map, data) {
            let geoLayer;
            if (geoLayer) geoLayer.remove();

            geoLayer = L.geoJSON(data);

            geoLayer.addTo(map);
        }

        function highlightFeature(e) {
            e.target.setStyle({
                weight: 3,
                color: '#FFFF00' // yellow on hover
            });
        }

        window.onload = async() => {
            let mapBounds = L.latLngBounds(
                L.latLng(-90, -180),
                L.latLng(90, 180)
            );
            let map = L.map('map', {
                center: [20, 0],
                zoom: 3,
                minZoom: 2,
                maxBounds: mapBounds,
                maxBoundsViscosity: 1.0,
                bounceAtZoomLimits: false
            });

            var Stadia_StamenTonerDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_dark/{z}/{x}/{y}{r}.{ext}', {
                minZoom: 0,
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            Stadia_StamenTonerDark.addTo(map);

            let response = await fetch("data/ufo-sightings.csv");
            let csvTextData = await response.text();
            let jsondata = await fromCSVtoJSON(csvTextData);

            addMarkers(map, jsondata);

            let responseCountries = await fetch("data/countries.json");
            let countriesText = await responseCountries.text();
            let countriesGeoJSON = JSON.parse(countriesText);

            let countriesLayer = L.geoJSON(countriesGeoJSON, {
                style: {
                    color: "#00FF00",
                    weight: 2,
                    fillOpacity: 0
                },
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: function(e) {
                            countriesLayer.resetStyle(e.target);
                        }
                    });
                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(feature.properties.name);
                    }
                }
            }).addTo(map);
        };
    </script>
</head>

<body>
    <div id="map"></div>
</body>

</html>